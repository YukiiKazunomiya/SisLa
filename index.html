<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SisterLab - Puskesmas Meureubo</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #06b6d4;
            --primary-dark: #0891b2;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --radius: 16px;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        * {margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        
        body {
            font-family:'Inter',system-ui,-apple-system,sans-serif;
            background:var(--bg);
            color:var(--text);
            line-height:1.6;
            -webkit-font-smoothing:antialiased;
            overflow-x:hidden;
        }

        /* LOGIN */
        #loginScreen {
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:linear-gradient(135deg,var(--primary-dark) 0%,var(--primary) 100%);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:10000;
        }

        .login-container {
            width:90%;
            max-width:400px;
            background:white;
            border-radius:24px;
            padding:48px 32px;
            box-shadow:0 20px 60px rgba(0,0,0,0.3);
            animation:slideUp 0.5s ease;
        }

        @keyframes slideUp {from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

        .login-logo {
            text-align:center;
            margin-bottom:40px;
        }

        .login-logo-icon {
            width:80px;
            height:80px;
            margin:0 auto 20px;
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            border-radius:20px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:2.5rem;
            color:white;
            box-shadow:0 8px 20px rgba(6,182,212,0.3);
            overflow:hidden;
            position:relative;
        }

        .login-logo-icon img {
            width:100%;
            height:100%;
            object-fit:contain;
            position:absolute;
            top:0;
            left:0;
            z-index:10;
        }

        .login-logo h1 {
            font-size:1.75rem;
            font-weight:800;
            color:#0f172a;
            margin-bottom:8px;
        }

        .login-logo p {
            font-size:0.938rem;
            color:#64748b;
            font-weight:500;
        }

        .input-wrapper {
            position:relative;
            margin-bottom:20px;
        }

        .input-wrapper label {
            display:block;
            font-size:0.875rem;
            font-weight:600;
            color:#334155;
            margin-bottom:8px;
        }

        .input-wrapper input {
            width:100%;
            padding:14px 16px;
            border:2px solid #e2e8f0;
            border-radius:12px;
            font-size:1rem;
            font-weight:500;
            color:#0f172a;
            background:white;
            transition:all 0.2s;
        }

        .input-wrapper input:focus {
            outline:none;
            border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(6,182,212,0.1);
        }

        .btn-login {
            width:100%;
            padding:16px;
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            color:white;
            border:none;
            border-radius:12px;
            font-size:1rem;
            font-weight:700;
            cursor:pointer;
            margin-top:24px;
            box-shadow:0 4px 12px rgba(6,182,212,0.3);
            transition:all 0.2s;
        }

        .btn-login:active {
            transform:scale(0.98);
        }

        /* MAIN APP */
        #mainApp {
            display:none;
            min-height:100vh;
        }

        /* HEADER */
        .header {
            background:var(--card);
            padding:16px 20px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            border-bottom:1px solid var(--border);
            position:sticky;
            top:0;
            z-index:100;
        }

        .header-left {
            display:flex;
            align-items:center;
            gap:12px;
        }

        .hamburger {
            width:40px;
            height:40px;
            display:flex;
            align-items:center;
            justify-content:center;
            background:transparent;
            border:none;
            cursor:pointer;
            font-size:1.5rem;
            color:var(--text);
        }

        .header-title h1 {
            font-size:1.25rem;
            font-weight:700;
            color:var(--text);
        }

        .header-right {
            display:flex;
            align-items:center;
            gap:12px;
        }

        .icon-btn {
            width:40px;
            height:40px;
            border-radius:50%;
            background:var(--primary);
            color:white;
            border:none;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:1.1rem;
            position:relative;
        }

        .icon-btn .badge {
            position:absolute;
            top:-2px;
            right:-2px;
            width:18px;
            height:18px;
            background:#ef4444;
            border-radius:50%;
            font-size:0.65rem;
            font-weight:700;
            display:flex;
            align-items:center;
            justify-content:center;
            border:2px solid var(--card);
        }

        /* SIDEBAR */
        .sidebar {
            position:fixed;
            top:0;
            left:-100%;
            width:85%;
            max-width:320px;
            height:100%;
            background:var(--card);
            box-shadow:4px 0 24px rgba(0,0,0,0.15);
            z-index:200;
            transition:left 0.3s ease;
            overflow-y:auto;
        }

        .sidebar.active {
            left:0;
        }

        .sidebar-overlay {
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.5);
            z-index:199;
            opacity:0;
            pointer-events:none;
            transition:opacity 0.3s;
        }

        .sidebar-overlay.active {
            opacity:1;
            pointer-events:all;
        }

        .sidebar-header {
            padding:24px 20px;
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            display:flex;
            align-items:center;
            gap:16px;
        }

        .sidebar-logo {
            width:56px;
            height:56px;
            background:rgba(255,255,255,0.2);
            border-radius:16px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:2rem;
            color:white;
            overflow:hidden;
            position:relative;
        }

        .sidebar-logo img {
            width:100%;
            height:100%;
            object-fit:contain;
            position:absolute;
            top:0;
            left:0;
            z-index:10;
        }

        .sidebar-info h2 {
            font-size:1.125rem;
            font-weight:700;
            color:white;
            margin-bottom:4px;
        }

        .sidebar-info p {
            font-size:0.813rem;
            color:rgba(255,255,255,0.9);
        }

        .sidebar-user {
            padding:20px;
            border-bottom:1px solid var(--border);
        }

        .user-card {
            background:var(--bg);
            padding:16px;
            border-radius:12px;
            display:flex;
            align-items:center;
            gap:12px;
        }

        .user-avatar {
            width:48px;
            height:48px;
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            border-radius:12px;
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-size:1.25rem;
            font-weight:700;
        }

        .user-info h3 {
            font-size:1rem;
            font-weight:700;
            color:var(--text);
            margin-bottom:2px;
        }

        .user-info p {
            font-size:0.813rem;
            color:var(--text-secondary);
        }

        .sidebar-menu {
            padding:12px 0;
        }

        .menu-item {
            padding:16px 20px;
            display:flex;
            align-items:center;
            gap:16px;
            cursor:pointer;
            transition:all 0.2s;
            border-left:3px solid transparent;
        }

        .menu-item:active {
            background:rgba(6,182,212,0.05);
        }

        .menu-item.active {
            background:rgba(6,182,212,0.1);
            border-left-color:var(--primary);
        }

        .menu-icon {
            width:24px;
            font-size:1.25rem;
            color:var(--text-secondary);
        }

        .menu-item.active .menu-icon {
            color:var(--primary);
        }

        .menu-text {
            font-size:1rem;
            font-weight:600;
            color:var(--text);
        }

        .menu-item.logout {
            color:#ef4444;
            margin-top:12px;
            border-top:1px solid var(--border);
            padding-top:24px;
        }

        .menu-item.logout .menu-icon {
            color:#ef4444;
        }

        /* MAIN CONTENT */
        .main {
            padding:20px;
            padding-bottom:80px;
        }

        /* WELCOME CARD */
        .welcome-card {
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            border-radius:20px;
            padding:28px 24px;
            color:white;
            margin-bottom:24px;
        }

        .welcome-card h2 {
            font-size:1.5rem;
            font-weight:800;
            margin-bottom:8px;
        }

        .welcome-card p {
            font-size:0.938rem;
            opacity:0.95;
        }

        /* STAT CARDS */
        .stats-grid {
            display:grid;
            grid-template-columns:repeat(2,1fr);
            gap:16px;
            margin-bottom:24px;
        }

        .stat-card {
            background:var(--card);
            border-radius:16px;
            padding:20px;
            border:1px solid var(--border);
        }

        .stat-header {
            display:flex;
            justify-content:space-between;
            align-items:flex-start;
            margin-bottom:16px;
        }

        .stat-title {
            font-size:0.875rem;
            color:var(--text-secondary);
            font-weight:600;
        }

        .stat-icon {
            width:44px;
            height:44px;
            border-radius:12px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:1.25rem;
            color:white;
        }

        .stat-icon.blue {background:linear-gradient(135deg,#3b82f6,#2563eb);}
        .stat-icon.teal {background:linear-gradient(135deg,#14b8a6,#0d9488);}
        .stat-icon.red {background:linear-gradient(135deg,#ef4444,#dc2626);}
        .stat-icon.green {background:linear-gradient(135deg,#10b981,#059669);}

        .stat-value {
            font-size:2rem;
            font-weight:800;
            color:var(--text);
            margin-bottom:4px;
        }

        .stat-label {
            font-size:0.813rem;
            color:var(--text-secondary);
            font-weight:500;
        }

        /* SECTION */
        .section {
            margin-bottom:24px;
        }

        .section-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:16px;
        }

        .section-title {
            font-size:1.125rem;
            font-weight:700;
            color:var(--text);
        }

        .section-action {
            font-size:0.875rem;
            color:var(--primary);
            font-weight:600;
            cursor:pointer;
        }

        /* CARD */
        .card {
            background:var(--card);
            border-radius:16px;
            padding:20px;
            border:1px solid var(--border);
            margin-bottom:16px;
        }

        .card-title {
            font-size:1rem;
            font-weight:700;
            color:var(--text);
            margin-bottom:16px;
            display:flex;
            align-items:center;
            gap:12px;
        }

        .card-icon {
            width:40px;
            height:40px;
            border-radius:10px;
            background:rgba(6,182,212,0.1);
            display:flex;
            align-items:center;
            justify-content:center;
            color:var(--primary);
            font-size:1.1rem;
        }

        /* FORM */
        .form-group {
            margin-bottom:20px;
        }

        .form-label {
            display:block;
            font-size:0.875rem;
            font-weight:600;
            color:var(--text);
            margin-bottom:8px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width:100%;
            padding:14px 16px;
            border:2px solid var(--border);
            border-radius:12px;
            font-size:0.938rem;
            font-weight:500;
            color:var(--text);
            background:var(--card);
            transition:all 0.2s;
            font-family:inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline:none;
            border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(6,182,212,0.1);
        }

        .form-textarea {
            resize:vertical;
            min-height:100px;
        }

        .form-hint {
            font-size:0.813rem;
            color:var(--text-secondary);
            margin-top:6px;
        }

        /* BUTTONS */
        .btn {
            padding:14px 24px;
            border-radius:12px;
            font-size:0.938rem;
            font-weight:700;
            border:none;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            transition:all 0.2s;
        }

        .btn i {
            font-size:1.1rem;
        }

        .btn-primary {
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            color:white;
            box-shadow:0 4px 12px rgba(6,182,212,0.3);
        }

        .btn-primary:active {
            transform:scale(0.98);
        }

        .btn-secondary {
            background:var(--bg);
            color:var(--text);
            border:2px solid var(--border);
        }

        .btn-danger {
            background:#ef4444;
            color:white;
            box-shadow:0 4px 12px rgba(239,68,68,0.3);
        }

        .btn-full {
            width:100%;
        }

        .btn-group {
            display:flex;
            gap:12px;
        }

        /* UPLOAD */
        .upload-area {
            border:2px dashed var(--border);
            border-radius:16px;
            padding:40px 20px;
            text-align:center;
            cursor:pointer;
            transition:all 0.2s;
            margin-bottom:20px;
        }

        .upload-area:active {
            background:rgba(6,182,212,0.05);
            border-color:var(--primary);
        }

        .upload-icon {
            width:64px;
            height:64px;
            margin:0 auto 16px;
            background:rgba(6,182,212,0.1);
            border-radius:16px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:2rem;
            color:var(--primary);
        }

        .upload-title {
            font-size:1rem;
            font-weight:700;
            color:var(--text);
            margin-bottom:6px;
        }

        .upload-desc {
            font-size:0.875rem;
            color:var(--text-secondary);
        }

        /* LIST ITEM */
        .list-item {
            background:var(--card);
            border-radius:12px;
            padding:16px;
            border:1px solid var(--border);
            margin-bottom:12px;
            display:flex;
            align-items:center;
            gap:16px;
            cursor:pointer;
        }

        .item-icon {
            width:48px;
            height:48px;
            border-radius:12px;
            background:rgba(6,182,212,0.1);
            display:flex;
            align-items:center;
            justify-content:center;
            color:var(--primary);
            font-size:1.25rem;
            flex-shrink:0;
        }

        .item-content {
            flex:1;
            min-width:0;
        }

        .item-title {
            font-size:1rem;
            font-weight:700;
            color:var(--text);
            margin-bottom:4px;
        }

        .item-desc {
            font-size:0.875rem;
            color:var(--text-secondary);
        }

        .item-badge {
            padding:6px 12px;
            border-radius:20px;
            font-size:0.75rem;
            font-weight:700;
            flex-shrink:0;
        }

        .badge-success {
            background:rgba(16,185,129,0.15);
            color:#10b981;
        }

        .badge-danger {
            background:rgba(239,68,68,0.15);
            color:#ef4444;
        }

        /* EMPTY STATE */
        .empty-state {
            padding:60px 20px;
            text-align:center;
        }

        .empty-icon {
            width:100px;
            height:100px;
            margin:0 auto 20px;
            background:rgba(6,182,212,0.1);
            border-radius:20px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:3rem;
            color:var(--primary);
        }

        .empty-title {
            font-size:1.25rem;
            font-weight:700;
            color:var(--text);
            margin-bottom:8px;
        }

        .empty-desc {
            font-size:0.938rem;
            color:var(--text-secondary);
        }

        /* FLOATING ACTION */
        .fab {
            position:fixed;
            bottom:20px;
            right:20px;
            width:56px;
            height:56px;
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-size:1.5rem;
            box-shadow:0 8px 24px rgba(6,182,212,0.4);
            cursor:pointer;
            border:none;
            z-index:50;
        }

        .fab:active {
            transform:scale(0.95);
        }

        /* MODAL */
        .modal {
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.5);
            display:none;
            align-items:flex-end;
            justify-content:center;
            z-index:300;
            animation:fadeIn 0.3s;
        }

        .modal.active {
            display:flex;
        }

        @keyframes fadeIn {from{opacity:0}to{opacity:1}}

        .modal-content {
            background:var(--card);
            width:100%;
            max-height:90vh;
            border-radius:20px 20px 0 0;
            overflow-y:auto;
            animation:slideUpModal 0.3s ease;
        }

        @keyframes slideUpModal {from{transform:translateY(100%)}to{transform:translateY(0)}}

        .modal-header {
            padding:20px;
            border-bottom:1px solid var(--border);
            display:flex;
            justify-content:space-between;
            align-items:center;
            position:sticky;
            top:0;
            background:var(--card);
            z-index:1;
        }

        .modal-title {
            font-size:1.25rem;
            font-weight:700;
            color:var(--text);
        }

        .modal-close {
            width:36px;
            height:36px;
            border-radius:50%;
            background:var(--bg);
            border:none;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:1.25rem;
            color:var(--text);
        }

        .modal-body {
            padding:20px;
        }

        /* AI CHAT */
        .chat-container {
            display:flex;
            flex-direction:column;
            gap:16px;
            margin-bottom:16px;
        }

        .chat-message {
            display:flex;
            gap:12px;
        }

        .chat-message.user {
            flex-direction:row-reverse;
        }

        .chat-avatar {
            width:36px;
            height:36px;
            border-radius:50%;
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-size:1rem;
            flex-shrink:0;
        }

        .chat-message.user .chat-avatar {
            background:var(--bg);
            color:var(--text);
        }

        .chat-bubble {
            max-width:75%;
            padding:14px 16px;
            border-radius:16px;
            font-size:0.938rem;
            line-height:1.5;
        }

        .chat-message.bot .chat-bubble {
            background:var(--bg);
            color:var(--text);
            border-radius:16px 16px 16px 4px;
        }

        .chat-message.user .chat-bubble {
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            color:white;
            border-radius:16px 16px 4px 16px;
        }

        .chat-input-wrapper {
            display:flex;
            gap:12px;
            padding:16px 20px;
            border-top:1px solid var(--border);
            background:var(--card);
            position:sticky;
            bottom:0;
        }

        .chat-input {
            flex:1;
            padding:12px 16px;
            border:2px solid var(--border);
            border-radius:24px;
            font-size:0.938rem;
            background:var(--bg);
            color:var(--text);
            font-family:inherit;
        }

        .chat-input:focus {
            outline:none;
            border-color:var(--primary);
        }

        .chat-send {
            width:48px;
            height:48px;
            border-radius:50%;
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            border:none;
            color:white;
            font-size:1.25rem;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
        }

        /* CHART */
        .chart-wrapper {
            height:250px;
            margin-bottom:16px;
        }

        /* Logo Preview */
        .logo-preview {
            width:120px;
            height:120px;
            margin:0 auto 16px;
            background:rgba(6,182,212,0.1);
            border-radius:16px;
            display:flex;
            align-items:center;
            justify-content:center;
            overflow:hidden;
            border:2px dashed var(--border);
            position:relative;
        }

        .logo-preview img {
            width:100%;
            height:100%;
            object-fit:contain;
            position:absolute;
            top:0;
            left:0;
            z-index:10;
        }

        .logo-preview i {
            font-size:3rem;
            color:var(--primary);
        }

        /* THEME PRESETS */
        .theme-presets {
            display:grid;
            grid-template-columns:repeat(5,1fr);
            gap:12px;
            margin-bottom:20px;
        }

        .theme-preset {
            height:50px;
            border-radius:12px;
            cursor:pointer;
            border:3px solid transparent;
            transition:all 0.2s;
        }

        .theme-preset:active {
            transform:scale(0.95);
        }

        .theme-preset.active {
            border-color:var(--text);
        }

        .theme-cyan {background:linear-gradient(135deg,#06b6d4,#0891b2);}
        .theme-blue {background:linear-gradient(135deg,#3b82f6,#2563eb);}
        .theme-green {background:linear-gradient(135deg,#10b981,#059669);}
        .theme-purple {background:linear-gradient(135deg,#8b5cf6,#7c3aed);}
        .theme-orange {background:linear-gradient(135deg,#f97316,#ea580c);}

        /* LAB PARAMETER ROW */
        .param-row {
            background:var(--bg);
            border-radius:12px;
            padding:16px;
            margin-bottom:12px;
        }

        .param-header {
            display:flex;
            align-items:center;
            gap:12px;
            margin-bottom:12px;
        }

        .param-checkbox {
            width:24px;
            height:24px;
            accent-color:var(--primary);
            cursor:pointer;
        }

        .param-name {
            flex:1;
            font-weight:600;
            font-size:0.938rem;
        }

        .param-normal {
            font-size:0.813rem;
            color:var(--text-secondary);
            margin-bottom:8px;
        }

        .param-input {
            width:100%;
            padding:10px 14px;
            border:2px solid var(--border);
            border-radius:10px;
            font-size:0.938rem;
            background:var(--card);
            color:var(--text);
        }

        .param-input:focus {
            outline:none;
            border-color:var(--primary);
        }

        /* UTILITIES */
        .mt-20 {margin-top:20px;}
        .mb-20 {margin-bottom:20px;}
        .hidden {display:none;}

        @media print {
            body * {visibility:hidden;}
            #printArea,#printArea * {visibility:visible;}
            #printArea {position:absolute;left:0;top:0;width:100%;background:white;padding:20mm;}
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <div class="login-logo-icon" id="loginLogoIcon">
                    <i class="fas fa-flask"></i>
                </div>
                <h1>SisterLab</h1>
                <p>Lab Management</p>
            </div>
            <form id="loginForm" onsubmit="return login(event)">
                <div class="input-wrapper">
                    <label>Username</label>
                    <input type="text" id="username" placeholder="Masukkan username" required>
                </div>
                <div class="input-wrapper">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Masukkan password" required>
                </div>
                <button type="submit" class="btn-login">Masuk</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <!-- HEADER -->
        <header class="header">
            <div class="header-left">
                <button class="hamburger" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-title">
                    <h1>Puskesmas Meureubo</h1>
                </div>
            </div>
            <div class="header-right">
                <button class="icon-btn" onclick="showChat()">
                    <i class="fas fa-comment-dots"></i>
                </button>
            </div>
        </header>

        <!-- SIDEBAR -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo" id="sidebarLogoContainer">
                    <i class="fas fa-flask"></i>
                </div>
                <div class="sidebar-info">
                    <h2>SisterLab</h2>
                    <p>Lab Management</p>
                </div>
            </div>

            <div class="sidebar-user">
                <div class="user-card">
                    <div class="user-avatar">
                        <span id="userInitial">A</span>
                    </div>
                    <div class="user-info">
                        <h3 id="userName">Admin</h3>
                        <p>user</p>
                    </div>
                </div>
            </div>

            <div class="sidebar-menu">
                <div class="menu-item active" onclick="showPage('dashboard')">
                    <i class="fas fa-th-large menu-icon"></i>
                    <span class="menu-text">Dashboard</span>
                </div>
                <div class="menu-item" onclick="showPage('data')">
                    <i class="fas fa-users menu-icon"></i>
                    <span class="menu-text">Data Pasien</span>
                </div>
                <div class="menu-item" onclick="showPage('input')">
                    <i class="fas fa-flask menu-icon"></i>
                    <span class="menu-text">Input Lab</span>
                </div>
                <div class="menu-item" onclick="showPage('settings')">
                    <i class="fas fa-cog menu-icon"></i>
                    <span class="menu-text">Pengaturan</span>
                </div>
                <div class="menu-item logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt menu-icon"></i>
                    <span class="menu-text">Keluar</span>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <main class="main">
            <!-- DASHBOARD PAGE -->
            <div id="dashboardPage">
                <div class="welcome-card">
                    <h2>Selamat Datang di SisterLab</h2>
                    <p>Sistem Informasi Laboratorium Puskesmas Meureubo</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Pasien</div>
                            <div class="stat-icon blue">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalPatients">0</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Pemeriksaan</div>
                            <div class="stat-icon teal">
                                <i class="fas fa-flask"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalTests">0</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Pasien Bulan Ini</div>
                            <div class="stat-icon green">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="monthPatients">0</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Aktif Hari Ini</div>
                            <div class="stat-icon red">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="todayActive">Buka</div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Distribusi Pemeriksaan Lab</h3>
                    </div>
                    <div class="card">
                        <div class="chart-wrapper">
                            <canvas id="labChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Distribusi Gender Pasien</h3>
                    </div>
                    <div class="card">
                        <div class="chart-wrapper">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DATA PASIEN PAGE -->
            <div id="dataPage" class="hidden">
                <div class="section-header">
                    <h3 class="section-title">Data Pasien</h3>
                    <span class="section-action" onclick="showAddPatientFromData()">Tambah Pasien</span>
                </div>

                <div class="card">
                    <div class="form-group">
                        <input type="text" class="form-input" id="searchInput" placeholder="Cari berdasarkan nama, NIK, atau kategori..." oninput="searchPatients()">
                    </div>
                </div>

                <div id="patientList"></div>
            </div>

            <!-- INPUT LAB PAGE -->
            <div id="inputPage" class="hidden">
                <div class="section-header">
                    <h3 class="section-title" id="inputPageTitle">Tambah Pasien Baru</h3>
                </div>

                <div class="card" id="photoUploadCard">
                    <div class="upload-area" onclick="document.getElementById('photoUpload').click()">
                        <input type="file" id="photoUpload" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
                        <div class="upload-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="upload-title">Upload foto catatan pasien</div>
                        <div class="upload-desc">AI akan otomatis mengisi form</div>
                    </div>
                </div>

                <form id="patientForm" onsubmit="return savePatient(event)">
                    <div class="card">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            Data Pasien
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tanggal Pemeriksaan</label>
                            <input type="date" class="form-input" id="tanggal" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-input" id="nama" placeholder="Nama pasien" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">NIK / No. BPJS</label>
                            <input type="text" class="form-input" id="nik" placeholder="16 digit NIK">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Jenis Kelamin</label>
                            <select class="form-select" id="jenisKelamin" required>
                                <option value="">Pilih jenis kelamin</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Umur (tahun)</label>
                            <input type="number" class="form-input" id="umur" placeholder="Usia pasien" min="0" max="150">
                        </div>

                        <div class="form-group">
                            <label class="form-label">No. Telepon</label>
                            <input type="tel" class="form-input" id="telepon" placeholder="08xxxxxxxxxx">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Alamat</label>
                            <textarea class="form-textarea" id="alamat" placeholder="Alamat lengkap pasien"></textarea>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-vial"></i>
                            </div>
                            Kategori Pemeriksaan
                        </div>

                        <div class="form-group">
                            <label class="form-label">Kategori Pemeriksaan</label>
                            <select class="form-select" id="kategori" onchange="showKategoriFields()" required>
                                <option value="">Pilih kategori</option>
                                <option value="Hematologi">Hematologi</option>
                                <option value="Kimia Darah">Kimia Darah</option>
                                <option value="Urinalisis">Urinalisis</option>
                                <option value="Imunoserologi">Imunoserologi</option>
                                <option value="Mikrobiologi">Mikrobiologi</option>
                            </select>
                        </div>

                        <div id="kategoriFields"></div>
                    </div>

                    <div class="card">
                        <div class="form-group">
                            <label class="form-label">Catatan Tambahan</label>
                            <textarea class="form-textarea" id="catatan" placeholder="Tambahkan catatan pemeriksaan..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nama Petugas Lab</label>
                            <input type="text" class="form-input" id="petugas" placeholder="Nama petugas lab">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary btn-full" id="cancelEditBtn" onclick="cancelEdit()" style="display:none;">
                            <i class="fas fa-times"></i>
                            Batal Edit
                        </button>
                        <button type="submit" class="btn btn-primary btn-full" id="saveBtn">
                            <i class="fas fa-save"></i>
                            Simpan Data
                        </button>
                    </div>
                </form>
            </div>

            <!-- SETTINGS PAGE -->
            <div id="settingsPage" class="hidden">
                <div class="section-header">
                    <h3 class="section-title">Pengaturan</h3>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Tema Aplikasi</h3>
                    </div>

                    <div class="card">
                        <p class="mb-20" style="font-size:0.875rem;color:var(--text-secondary);">Pilih warna tema sesuai keinginan Anda</p>
                        
                        <div class="theme-presets">
                            <div class="theme-preset theme-cyan active" onclick="changeTheme('cyan')" title="Cyan"></div>
                            <div class="theme-preset theme-blue" onclick="changeTheme('blue')" title="Blue"></div>
                            <div class="theme-preset theme-green" onclick="changeTheme('green')" title="Green"></div>
                            <div class="theme-preset theme-purple" onclick="changeTheme('purple')" title="Purple"></div>
                            <div class="theme-preset theme-orange" onclick="changeTheme('orange')" title="Orange"></div>
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn btn-primary btn-full" onclick="toggleDarkMode()">
                                <i class="fas fa-moon" id="darkModeIcon"></i>
                                <span id="darkModeText">Mode Gelap</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Logo Aplikasi</h3>
                    </div>

                    <div class="card">
                        <div class="logo-preview" id="logoPreview">
                            <i class="fas fa-flask"></i>
                        </div>
                        <input type="file" id="logoUpload" accept="image/*" style="display:none;" onchange="handleLogoUpload(event)">
                        <button type="button" class="btn btn-primary btn-full" onclick="document.getElementById('logoUpload').click()">
                            <i class="fas fa-upload"></i>
                            Upload Logo Puskesmas
                        </button>
                        <button type="button" class="btn btn-secondary btn-full mt-20" onclick="resetLogo()">
                            <i class="fas fa-redo"></i>
                            Reset ke Default
                        </button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Download Recap Bulanan</h3>
                    </div>

                    <div class="list-item" onclick="downloadRecap()">
                        <div class="item-icon" style="background:rgba(16,185,129,0.1);color:#10b981;">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="item-content">
                            <div class="item-title">Download Excel Recap</div>
                            <div class="item-desc">Unduh data pasien lengkap dengan grafik</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Backup & Restore Database</h3>
                    </div>

                    <div class="list-item" onclick="downloadBackup()">
                        <div class="item-icon" style="background:rgba(16,185,129,0.1);color:#10b981;">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="item-content">
                            <div class="item-title">Download Backup</div>
                            <div class="item-desc">Cadangkan atau pulihkan data laboratorium</div>
                        </div>
                    </div>

                    <div class="list-item" onclick="document.getElementById('restoreFile').click()">
                        <input type="file" id="restoreFile" accept=".json" style="display:none;" onchange="restoreBackup(event)">
                        <div class="item-icon" style="background:rgba(59,130,246,0.1);color:#3b82f6;">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="item-content">
                            <div class="item-title">Restore Backup</div>
                            <div class="item-desc">Upload file backup untuk restore data</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title" style="color:#ef4444;">Danger Zone</h3>
                    </div>

                    <div class="list-item" onclick="resetDatabase()">
                        <div class="item-icon" style="background:rgba(239,68,68,0.1);color:#ef4444;">
                            <i class="fas fa-trash"></i>
                        </div>
                        <div class="item-content">
                            <div class="item-title" style="color:#ef4444;">Reset Database</div>
                            <div class="item-desc">Hapus semua data pasien dan pemeriksaan</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Informasi Sistem</h3>
                    </div>

                    <div class="card">
                        <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);">
                            <span style="color:var(--text-secondary);font-size:0.938rem;">Versi Aplikasi</span>
                            <span style="font-weight:700;">2.0.0</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);">
                            <span style="color:var(--text-secondary);font-size:0.938rem;">Sistem</span>
                            <span style="font-weight:700;">SisterLab - Puskesmas Meureubo</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:12px 0;">
                            <span style="color:var(--text-secondary);font-size:0.938rem;">Teknologi</span>
                            <span style="font-weight:700;">HTML + CSS + JavaScript</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- FAB -->
        <button class="fab" onclick="showAddPatient()">
            <i class="fas fa-plus"></i>
        </button>

        <!-- AI CHAT MODAL -->
        <div class="modal" id="chatModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-robot"></i>
                        AI Assistant
                    </h3>
                    <button class="modal-close" onclick="hideChat()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p style="font-size:0.875rem;color:var(--text-secondary);margin-bottom:20px;">
                        Asisten Lab Virtual
                    </p>
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message bot">
                            <div class="chat-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="chat-bubble">
                                Halo! Saya asisten virtual laboratorium. Ada yang bisa saya bantu?
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="chat-send" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- DETAIL MODAL -->
        <div class="modal" id="detailModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Detail Pasien</h3>
                    <button class="modal-close" onclick="hideDetail()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body" id="detailContent">
                </div>
            </div>
        </div>
    </div>

    <div id="printArea" style="display:none;"></div>

    <script>
        let currentUser=null;
        let db=[];
        let chart1=null;
        let chart2=null;
        let appLogo=null;
        let currentTheme='cyan';
        let isEditMode=false;
        let editPatientId=null;

        // THEME COLORS
        const themes={
            cyan:{primary:'#06b6d4',primaryDark:'#0891b2'},
            blue:{primary:'#3b82f6',primaryDark:'#2563eb'},
            green:{primary:'#10b981',primaryDark:'#059669'},
            purple:{primary:'#8b5cf6',primaryDark:'#7c3aed'},
            orange:{primary:'#f97316',primaryDark:'#ea580c'}
        };

        // LAB PARAMETERS
        const labParameters={
            Hematologi:[
                {id:'hb',name:'Hemoglobin (Hb)',unit:'g/dL',normal:'P: 12-16, L: 13-18'},
                {id:'leukosit',name:'Leukosit',unit:'/\u00b5L',normal:'4000-10000'},
                {id:'eritrosit',name:'Eritrosit',unit:'juta/\u00b5L',normal:'P: 3.5-5.5, L: 4.3-5.9'},
                {id:'trombosit',name:'Trombosit',unit:'/\u00b5L',normal:'150000-400000'},
                {id:'hematokrit',name:'Hematokrit',unit:'%',normal:'P: 36-46, L: 40-52'},
                {id:'led',name:'LED',unit:'mm/jam',normal:'P: 0-20, L: 0-15'},
                {id:'mch',name:'MCH',unit:'pg',normal:'27-33'},
                {id:'mchc',name:'MCHC',unit:'g/dL',normal:'33-37'},
                {id:'mcv',name:'MCV',unit:'fL',normal:'80-100'}
            ],
            'Kimia Darah':[
                {id:'gds',name:'Gula Darah Sewaktu (GDS)',unit:'mg/dL',normal:'70-140'},
                {id:'gdp',name:'Gula Darah Puasa (GDP)',unit:'mg/dL',normal:'70-100'},
                {id:'gd2pp',name:'Gula Darah 2 Jam PP (GD2PP)',unit:'mg/dL',normal:'<140'},
                {id:'asamurat',name:'Asam Urat',unit:'mg/dL',normal:'P: 2.4-6.0, L: 3.4-7.0'},
                {id:'kolesterol',name:'Kolesterol Total',unit:'mg/dL',normal:'<200'},
                {id:'hdl',name:'HDL',unit:'mg/dL',normal:'>40'},
                {id:'ldl',name:'LDL',unit:'mg/dL',normal:'<130'},
                {id:'trigliserida',name:'Trigliserida',unit:'mg/dL',normal:'<150'},
                {id:'sgot',name:'SGOT',unit:'U/L',normal:'P: 5-25, L: 5-40'},
                {id:'sgpt',name:'SGPT',unit:'U/L',normal:'P: 5-35, L: 5-45'},
                {id:'ureum',name:'Ureum',unit:'mg/dL',normal:'15-45'},
                {id:'kreatinin',name:'Kreatinin',unit:'mg/dL',normal:'P: 0.5-1.1, L: 0.6-1.2'}
            ],
            Urinalisis:[
                {id:'warna',name:'Warna',unit:'',normal:'Kuning jernih'},
                {id:'berat_jenis',name:'Berat Jenis',unit:'',normal:'1.010-1.025'},
                {id:'ph',name:'pH',unit:'',normal:'4.5-8.0'},
                {id:'protein',name:'Protein',unit:'',normal:'Negatif'},
                {id:'glukosa',name:'Glukosa',unit:'',normal:'Negatif'},
                {id:'keton',name:'Keton',unit:'',normal:'Negatif'},
                {id:'bilirubin',name:'Bilirubin',unit:'',normal:'Negatif'},
                {id:'urobilinogen',name:'Urobilinogen',unit:'',normal:'Negatif'},
                {id:'nitrit',name:'Nitrit',unit:'',normal:'Negatif'},
                {id:'eritrosit_urin',name:'Eritrosit',unit:'',normal:'0-2'},
                {id:'leukosit_urin',name:'Leukosit',unit:'',normal:'0-5'},
                {id:'silinder',name:'Silinder',unit:'',normal:'Negatif'},
                {id:'bakteri',name:'Bakteri',unit:'',normal:'Negatif'},
                {id:'Kristal',name:'Kristal',unit:'',normal:'Negatif'}
            ],
            Imunoserologi:[
                {id:'widal_o',name:'Widal O',unit:'titer',normal:'<1:80'},
                {id:'widal_h',name:'Widal H',unit:'titer',normal:'<1:80'},
                {id:'hbsag',name:'HBsAg',unit:'',normal:'Negatif'},
                {id:'anti_hcv',name:'Anti-HCV',unit:'',normal:'Negatif'},
                {id:'hiv',name:'HIV',unit:'',normal:'Negatif'},
                {id:'rpr',name:'RPR/VDRL',unit:'',normal:'Negatif'},
                {id:'tpa',name:'TPHA',unit:'',normal:'Negatif'},
                {id:'chikungunya',name:'Chikungunya IgM/IgG',unit:'',normal:'Negatif'},
                {id:'dengue_igm',name:'Dengue IgM',unit:'',normal:'Negatif'},
                {id:'dengue_igg',name:'Dengue IgG',unit:'',normal:'Negatif'}
            ],
            Mikrobiologi:[
                {id:'hematologi_kultur',name:'Hematologi',unit:'',normal:'Normal'},
                {id:'leukosit_kultur',name:'Leukosit',unit:'',normal:'Normal'},
                {id:'trombosit_kultur',name:'Trombosit',unit:'',normal:'Normal'},
                {id:'kultur',name:'Kultur',unit:'',normal:'Negatif'},
                {id:'biakan',name:'Biakan',unit:'',normal:'Negatif'},
                {id:'sensitivitas',name:'Sensitivitas',unit:'',normal:'Normal'},
                {id:'gram',name:'Pewarnaan Gram',unit:'',normal:'Normal'},
                {id:'fungi',name:'Fungi',unit:'',normal:'Negatif'},
                {id:'parasit',name:'Parasit',unit:'',normal:'Negatif'},
                {id:'mikroskopis',name:'Pemeriksaan Mikroskopis',unit:'',normal:'Normal'}
            ]
        };

        // INIT
        document.addEventListener('DOMContentLoaded',()=>{
            document.getElementById('tanggal').value=new Date().toISOString().split('T')[0];
            loadDB();
            loadLogo();
            loadTheme();
            checkSession();
            
            // Apply logo to login page immediately after loading
            applyLogo();
        });

        // AUTH - FIXED VERSION
        function login(e) {
            e.preventDefault();
            const u=document.getElementById('username').value.trim();
            const p=document.getElementById('password').value.trim();
            const users={
                admin:{pass:'admin123',name:'Administrator'},
                mama:{pass:'mama123',name:'Mama'}
            };
            
            console.log('Attempting login for user:', u);
            console.log('Password provided:', p ? '***' : 'empty');
            
            if(users[u]&&users[u].pass===p) {
                console.log('Login successful');
                currentUser={username:u,fullName:users[u].name,loginTime:new Date().toISOString()};
                sessionStorage.setItem('sisterlab_user',JSON.stringify(currentUser));
                showApp();
            } else {
                console.log('Login failed');
                Swal.fire({
                    icon:'error',
                    title:'Login Gagal',
                    text:'Username atau password salah!'
                });
            }
        }

        function checkSession() {
            const saved=sessionStorage.getItem('sisterlab_user');
            if(saved) {
                try {
                    currentUser=JSON.parse(saved);
                    console.log('Session found, user:', currentUser.username);
                    showApp();
                } catch(e) {
                    console.log('Invalid session data');
                    sessionStorage.removeItem('sisterlab_user');
                }
            }
        }

        function showApp() {
            console.log('Showing app for user:', currentUser ? currentUser.username : 'unknown');
            document.getElementById('loginScreen').style.display='none';
            document.getElementById('mainApp').style.display='block';
            document.getElementById('userName').textContent=currentUser.fullName;
            document.getElementById('userInitial').textContent=currentUser.fullName.charAt(0).toUpperCase();
            updateDashboard();
            renderPatients();
            applyLogo();
            applyTheme();
        }

        function logout() {
            Swal.fire({
                title:'Logout?',
                text:'Anda yakin ingin keluar?',
                icon:'question',
                showCancelButton:true,
                confirmButtonText:'Ya',
                cancelButtonText:'Batal'
            }).then(r=>{
                if(r.isConfirmed) {
                    sessionStorage.removeItem('sisterlab_user');
                    currentUser=null;
                    location.reload();
                }
            });
        }

        // UI
        function toggleSidebar() {
            const sidebar=document.getElementById('sidebar');
            const overlay=document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function showPage(page) {
            toggleSidebar();
            document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
            
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('dataPage').classList.add('hidden');
            document.getElementById('inputPage').classList.add('hidden');
            document.getElementById('settingsPage').classList.add('hidden');
            
            if(page==='dashboard') {
                document.getElementById('dashboardPage').classList.remove('hidden');
                document.querySelectorAll('.menu-item')[0].classList.add('active');
                updateDashboard();
            } else if(page==='data') {
                document.getElementById('dataPage').classList.remove('hidden');
                document.querySelectorAll('.menu-item')[1].classList.add('active');
                renderPatients();
            } else if(page==='input') {
                document.getElementById('inputPage').classList.remove('hidden');
                document.querySelectorAll('.menu-item')[2].classList.add('active');
                if(!isEditMode)resetForm();
            } else if(page==='settings') {
                document.getElementById('settingsPage').classList.remove('hidden');
                document.querySelectorAll('.menu-item')[3].classList.add('active');
            }
        }

        function showAddPatient() {
            resetForm();
            showPage('input');
        }

        function showAddPatientFromData() {
            resetForm();
            showPage('input');
        }

        // THEME
        function loadTheme() {
            const savedTheme=localStorage.getItem('sisterlab_theme');
            if(savedTheme) {
                currentTheme=savedTheme;
            }
            
            const savedDark=localStorage.getItem('sisterlab_dark');
            if(savedDark==='true') {
                document.documentElement.setAttribute('data-theme','dark');
                updateDarkModeUI(true);
            }
        }

        function changeTheme(theme) {
            currentTheme=theme;
            localStorage.setItem('sisterlab_theme',theme);
            applyTheme();
            
            document.querySelectorAll('.theme-preset').forEach(el=>el.classList.remove('active'));
            document.querySelector(`.theme-${theme}`).classList.add('active');
            
            Swal.fire({
                icon:'success',
                title:'Tema Berhasil Diubah!',
                timer:1000,
                showConfirmButton:false
            });
        }

        function applyTheme() {
            const theme=themes[currentTheme];
            document.documentElement.style.setProperty('--primary',theme.primary);
            document.documentElement.style.setProperty('--primary-dark',theme.primaryDark);
        }

        function toggleDarkMode() {
            const html=document.documentElement;
            if(html.getAttribute('data-theme')==='dark') {
                html.removeAttribute('data-theme');
                localStorage.setItem('sisterlab_dark','false');
                updateDarkModeUI(false);
            } else {
                html.setAttribute('data-theme','dark');
                localStorage.setItem('sisterlab_dark','true');
                updateDarkModeUI(true);
            }
        }

        function updateDarkModeUI(isDark) {
            const icon=document.getElementById('darkModeIcon');
            const text=document.getElementById('darkModeText');
            if(icon&&text) {
                if(isDark) {
                    icon.className='fas fa-sun';
                    text.textContent='Mode Terang';
                } else {
                    icon.className='fas fa-moon';
                    text.textContent='Mode Gelap';
                }
            }
        }

        // DATABASE
        function loadDB() {
            const saved=localStorage.getItem('sisterlab_db');
            if(saved) db=JSON.parse(saved);
        }

        function saveDB() {
            localStorage.setItem('sisterlab_db',JSON.stringify(db));
            updateDashboard();
            renderPatients();
        }

        // LOGO
        function loadLogo() {
            const saved=localStorage.getItem('sisterlab_logo');
            if(saved) {
                appLogo=saved;
                console.log('Logo loaded from localStorage');
            } else {
                console.log('No logo found in localStorage');
            }
        }

        function applyLogo() {
            if(!appLogo)return;
            
            const logoHtml=`<img src="${appLogo}" alt="Logo" style="width:100%;height:100%;object-fit:cover;">`;
            
            const loginIcon=document.getElementById('loginLogoIcon');
            if(loginIcon) {
                loginIcon.innerHTML=logoHtml;
                loginIcon.style.background='transparent';
                loginIcon.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)';
            }
            
            const sidebarLogo=document.getElementById('sidebarLogoContainer');
            if(sidebarLogo) {
                sidebarLogo.innerHTML=logoHtml;
                sidebarLogo.style.background='transparent';
            }
            
            const preview=document.getElementById('logoPreview');
            if(preview)preview.innerHTML=logoHtml;
        }

        function handleLogoUpload(e) {
            const file=e.target.files[0];
            if(!file)return;
            
            if(!file.type.startsWith('image/')) {
                Swal.fire({
                    icon:'error',
                    title:'File Tidak Valid',
                    text:'Silakan upload file gambar (PNG, JPG, SVG)'
                });
                return;
            }
            
            const reader=new FileReader();
            reader.onload=function(ev) {
                appLogo=ev.target.result;
                localStorage.setItem('sisterlab_logo',appLogo);
                applyLogo();
                
                // Update preview immediately
                const preview=document.getElementById('logoPreview');
                if(preview) {
                    preview.innerHTML=`<img src="${appLogo}" alt="Logo" style="width:100%;height:100%;object-fit:cover;">`;
                }
                
                Swal.fire({
                    icon:'success',
                    title:'Logo Berhasil Diupdate!',
                    text:'Logo akan muncul di semua halaman termasuk halaman login',
                    timer:2000,
                    showConfirmButton:false
                });
            };
            reader.readAsDataURL(file);
        }

        function resetLogo() {
            Swal.fire({
                title:'Reset Logo?',
                text:'Logo akan dikembalikan ke default',
                icon:'question',
                showCancelButton:true,
                confirmButtonText:'Ya',
                cancelButtonText:'Batal'
            }).then(r=>{
                if(r.isConfirmed) {
                    appLogo=null;
                    localStorage.removeItem('sisterlab_logo');
                    
                    const defaultIcon='<i class="fas fa-flask"></i>';
                    document.getElementById('loginLogoIcon').innerHTML=defaultIcon;
                    document.getElementById('sidebarLogoContainer').innerHTML=defaultIcon;
                    document.getElementById('logoPreview').innerHTML=defaultIcon;
                    
                    Swal.fire({
                        icon:'success',
                        title:'Logo Direset!',
                        timer:1500,
                        showConfirmButton:false
                    });
                }
            });
        }

        // DASHBOARD
        function updateDashboard() {
            document.getElementById('totalPatients').textContent=db.length;
            document.getElementById('totalTests').textContent=db.length;
            
            const month=new Date().toISOString().slice(0,7);
            const monthCount=db.filter(d=>d.tanggal&&d.tanggal.startsWith(month)).length;
            document.getElementById('monthPatients').textContent=monthCount;
            
            updateCharts();
        }

        function updateCharts() {
            const ctx1=document.getElementById('labChart');
            if(!ctx1)return;
            
            const categories={};
            db.forEach(p=>{
                const kat=p.kategori||'Lainnya';
                categories[kat]=(categories[kat]||0)+1;
            });
            
            if(chart1)chart1.destroy();
            chart1=new Chart(ctx1,{
                type:'doughnut',
                data:{
                    labels:Object.keys(categories),
                    datasets:[{
                        data:Object.values(categories),
                        backgroundColor:['#06b6d4','#14b8a6','#10b981','#f59e0b','#ef4444'],
                        borderWidth:0
                    }]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{
                        legend:{position:'bottom',labels:{padding:15,font:{size:12}}}
                    }
                }
            });
            
            const ctx2=document.getElementById('genderChart');
            if(!ctx2)return;
            
            let l=0,p=0;
            db.forEach(d=>{
                if(d.jenisKelamin==='Laki-laki')l++;
                else if(d.jenisKelamin==='Perempuan')p++;
            });
            
            if(chart2)chart2.destroy();
            chart2=new Chart(ctx2,{
                type:'bar',
                data:{
                    labels:['Laki-laki','Perempuan'],
                    datasets:[{
                        label:'Jumlah Pasien',
                        data:[l,p],
                        backgroundColor:['#06b6d4','#ec4899'],
                        borderRadius:8
                    }]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{legend:{display:false}},
                    scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}
                }
            });
        }

        // PATIENTS
        function renderPatients() {
            const container=document.getElementById('patientList');
            if(!container)return;
            
            if(db.length===0) {
                container.innerHTML=`
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-inbox"></i></div>
                        <div class="empty-title">Belum ada data pasien</div>
                        <div class="empty-desc">Mulai dengan menambahkan pasien baru</div>
                    </div>
                `;
                return;
            }
            
            let html='';
            db.slice().reverse().forEach(p=>{
                html+=`
                    <div class="list-item" onclick="showPatientDetail('${p.id}')">
                        <div class="item-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="item-content">
                            <div class="item-title">${p.nama}</div>
                            <div class="item-desc">${p.kategori||'Tidak ada kategori'} \u2022 ${formatDate(p.tanggal)}</div>
                        </div>
                        <div class="item-badge badge-success">
                            ${p.jenisKelamin==='Laki-laki'?'L':'P'}
                        </div>
                    </div>
                `;
            });
            container.innerHTML=html;
        }

        function searchPatients() {
            const query=document.getElementById('searchInput').value.toLowerCase();
            const container=document.getElementById('patientList');
            
            if(!query) {
                renderPatients();
                return;
            }
            
            const filtered=db.filter(p=>
                p.nama.toLowerCase().includes(query)||
                (p.nik&&p.nik.toLowerCase().includes(query))||
                (p.kategori&&p.kategori.toLowerCase().includes(query))
            );
            
            if(filtered.length===0) {
                container.innerHTML=`
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-search"></i></div>
                        <div class="empty-title">Tidak ditemukan</div>
                        <div class="empty-desc">Coba kata kunci lain</div>
                    </div>
                `;
                return;
            }
            
            let html='';
            filtered.slice().reverse().forEach(p=>{
                html+=`
                    <div class="list-item" onclick="showPatientDetail('${p.id}')">
                        <div class="item-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="item-content">
                            <div class="item-title">${p.nama}</div>
                            <div class="item-desc">${p.kategori||'Tidak ada kategori'} \u2022 ${formatDate(p.tanggal)}</div>
                        </div>
                        <div class="item-badge badge-success">
                            ${p.jenisKelamin==='Laki-laki'?'L':'P'}
                        </div>
                    </div>
                `;
            });
            container.innerHTML=html;
        }

        function showPatientDetail(id) {
            const p=db.find(x=>x.id===id);
            if(!p)return;
            
            let html=`
                <div class="card">
                    <div style="margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border);">
                        <div style="font-size:0.875rem;color:var(--text-secondary);margin-bottom:6px;">Nama Pasien</div>
                        <div style="font-size:1.125rem;font-weight:700;color:var(--text);">${p.nama}</div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:16px;">
                        <div>
                            <div style="font-size:0.813rem;color:var(--text-secondary);margin-bottom:4px;">NIK/BPJS</div>
                            <div style="font-weight:600;">${p.nik||'-'}</div>
                        </div>
                        <div>
                            <div style="font-size:0.813rem;color:var(--text-secondary);margin-bottom:4px;">Jenis Kelamin</div>
                            <div style="font-weight:600;">${p.jenisKelamin}</div>
                        </div>
                        <div>
                            <div style="font-size:0.813rem;color:var(--text-secondary);margin-bottom:4px;">Umur</div>
                            <div style="font-weight:600;">${p.umur||'-'} tahun</div>
                        </div>
                        <div>
                            <div style="font-size:0.813rem;color:var(--text-secondary);margin-bottom:4px;">Tanggal</div>
                            <div style="font-weight:600;">${formatDate(p.tanggal)}</div>
                        </div>
                    </div>
                    ${p.telepon?`
                        <div style="margin-bottom:16px;">
                            <div style="font-size:0.813rem;color:var(--text-secondary);margin-bottom:4px;">Telepon</div>
                            <div style="font-weight:600;">${p.telepon}</div>
                        </div>
                    `:''}
                    ${p.alamat?`
                        <div style="margin-bottom:16px;">
                            <div style="font-size:0.813rem;color:var(--text-secondary);margin-bottom:4px;">Alamat</div>
                            <div style="font-weight:600;">${p.alamat}</div>
                        </div>
                    `:''}
                    <div style="margin-bottom:16px;">
                        <div style="font-size:0.813rem;color:var(--text-secondary);margin-bottom:4px;">Kategori Pemeriksaan</div>
                        <div style="font-weight:600;">${p.kategori}</div>
                    </div>
                    ${p.parameters&&Object.keys(p.parameters).length>0?`
                        <div style="margin-bottom:16px;">
                            <div style="font-size:0.813rem;color:var(--text-secondary);margin-bottom:8px;">Hasil Pemeriksaan</div>
                            <div style="background:var(--bg);padding:12px;border-radius:8px;font-size:0.938rem;">
                                ${Object.entries(p.parameters).map(([key,value])=>`
                                    <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);">
                                        <span>${formatParamName(key)}</span>
                                        <strong>${value}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `:''}
                    ${p.catatan?`
                        <div style="margin-bottom:16px;">
                            <div style="font-size:0.813rem;color:var(--text-secondary);margin-bottom:8px;">Catatan</div>
                            <div style="background:var(--bg);padding:12px;border-radius:8px;font-size:0.938rem;">${p.catatan}</div>
                        </div>
                    `:''}
                    ${p.petugas?`
                        <div>
                            <div style="font-size:0.813rem;color:var(--text-secondary);margin-bottom:4px;">Petugas Lab</div>
                            <div style="font-weight:600;">${p.petugas}</div>
                        </div>
                    `:''}
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="editPatient('${p.id}')">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    <button class="btn btn-secondary" onclick="printPatient('${p.id}')">
                        <i class="fas fa-print"></i>
                        Print
                    </button>
                    <button class="btn btn-danger" onclick="deletePatient('${p.id}')">
                        <i class="fas fa-trash"></i>
                        Hapus
                    </button>
                </div>
            `;
            
            document.getElementById('detailContent').innerHTML=html;
            document.getElementById('detailModal').classList.add('active');
        }

        function hideDetail() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function editPatient(id) {
            const p=db.find(x=>x.id===id);
            if(!p)return;
            
            editPatientId=id;
            isEditMode=true;
            
            hideDetail();
            
            document.getElementById('inputPageTitle').textContent='Edit Data Pasien';
            document.getElementById('photoUploadCard').style.display='none';
            document.getElementById('cancelEditBtn').style.display='inline-flex';
            document.getElementById('saveBtn').innerHTML='<i class="fas fa-save"></i> Update Data';
            
            document.getElementById('tanggal').value=p.tanggal||'';
            document.getElementById('nama').value=p.nama||'';
            document.getElementById('nik').value=p.nik||'';
            document.getElementById('jenisKelamin').value=p.jenisKelamin||'';
            document.getElementById('umur').value=p.umur||'';
            document.getElementById('telepon').value=p.telepon||'';
            document.getElementById('alamat').value=p.alamat||'';
            document.getElementById('kategori').value=p.kategori||'';
            document.getElementById('catatan').value=p.catatan||'';
            document.getElementById('petugas').value=p.petugas||'';
            
            showKategoriFields();
            
            if(p.parameters) {
                Object.entries(p.parameters).forEach(([key,value])=>{
                    const input=document.getElementById(key);
                    if(input)input.value=value;
                    
                    const checkbox=document.getElementById(`${key}_check`);
                    if(checkbox)checkbox.checked=true;
                });
            }
            
            showPage('input');
        }

        function cancelEdit() {
            resetForm();
            showPage('data');
        }

        function resetForm() {
            isEditMode=false;
            editPatientId=null;
            
            document.getElementById('inputPageTitle').textContent='Tambah Pasien Baru';
            document.getElementById('photoUploadCard').style.display='block';
            document.getElementById('cancelEditBtn').style.display='none';
            document.getElementById('saveBtn').innerHTML='<i class="fas fa-save"></i> Simpan Data';
            
            document.getElementById('patientForm').reset();
            document.getElementById('tanggal').value=new Date().toISOString().split('T')[0];
            document.getElementById('kategoriFields').innerHTML='';
        }

        function deletePatient(id) {
            Swal.fire({
                title:'Hapus Data?',
                text:'Data yang dihapus tidak dapat dikembalikan',
                icon:'warning',
                showCancelButton:true,
                confirmButtonText:'Ya, Hapus',
                cancelButtonText:'Batal',
                confirmButtonColor:'#ef4444'
            }).then(r=>{
                if(r.isConfirmed) {
                    db=db.filter(p=>p.id!==id);
                    saveDB();
                    hideDetail();
                    Swal.fire({
                        icon:'success',
                        title:'Data Dihapus!',
                        timer:1500,
                        showConfirmButton:false
                    });
                }
            });
        }

        // FORM
        function showKategoriFields() {
            const kategori=document.getElementById('kategori').value;
            const container=document.getElementById('kategoriFields');
            
            if(!kategori) {
                container.innerHTML='';
                return;
            }
            
            const params=labParameters[kategori];
            if(!params) {
                container.innerHTML='';
                return;
            }
            
            let fields='';
            params.forEach(param=>{
                fields+=`
                    <div class="param-row">
                        <div class="param-header">
                            <input type="checkbox" class="param-checkbox" id="${param.id}_check" onchange="toggleParam('${param.id}')">
                            <div class="param-name">${param.name}</div>
                        </div>
                        <div class="param-normal">Normal: ${param.normal}</div>
                        <input type="text" class="param-input" id="${param.id}" placeholder="Masukkan nilai...">
                    </div>
                `;
            });
            
            container.innerHTML=fields;
        }

        function toggleParam(paramId) {
            const checkbox=document.getElementById(`${paramId}_check`);
            const input=document.getElementById(paramId);
            
            if(checkbox.checked) {
                input.disabled=false;
                input.style.opacity='1';
            } else {
                input.disabled=true;
                input.style.opacity='0.5';
                input.value='';
            }
        }

        function savePatient(e) {
            e.preventDefault();
            
            const kategori=document.getElementById('kategori').value;
            const params={};
            
            if(kategori&&labParameters[kategori]) {
                labParameters[kategori].forEach(param=>{
                    const checkbox=document.getElementById(`${param.id}_check`);
                    const input=document.getElementById(param.id);
                    
                    if(checkbox&&checkbox.checked&&input&&input.value.trim()) {
                        params[param.id]=input.value.trim();
                    }
                });
            }
            
            const data={
                id:isEditMode?editPatientId:Date.now().toString(),
                tanggal:document.getElementById('tanggal').value,
                nama:document.getElementById('nama').value,
                nik:document.getElementById('nik').value,
                jenisKelamin:document.getElementById('jenisKelamin').value,
                umur:document.getElementById('umur').value,
                telepon:document.getElementById('telepon').value,
                alamat:document.getElementById('alamat').value,
                kategori:kategori,
                parameters:Object.keys(params).length>0?params:null,
                catatan:document.getElementById('catatan').value,
                petugas:document.getElementById('petugas').value,
                timestamp:new Date().toISOString()
            };
            
            if(isEditMode) {
                const index=db.findIndex(p=>p.id===editPatientId);
                if(index!==-1) {
                    db[index]=data;
                }
                
                Swal.fire({
                    icon:'success',
                    title:'Data Berhasil Diupdate!',
                    text:`Data ${data.nama} telah diperbarui`,
                    timer:1500,
                    showConfirmButton:false
                }).then(()=>{
                    resetForm();
                    showPage('data');
                });
            } else {
                db.push(data);
                
                Swal.fire({
                    icon:'success',
                    title:'Data Berhasil Disimpan!',
                    text:`Data ${data.nama} telah tersimpan`,
                    timer:1500,
                    showConfirmButton:false
                }).then(()=>{
                    resetForm();
                    showPage('data');
                });
            }
            
            saveDB();
        }

        // OCR
        function handlePhotoUpload(e) {
            const file=e.target.files[0];
            if(!file)return;
            
            Swal.fire({
                title:'Memproses dengan AI OCR...',
                html:'<div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #06b6d4;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto;"></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style><p>Mohon tunggu...</p>',
                showConfirmButton:false,
                allowOutsideClick:false
            });
            
            const reader=new FileReader();
            reader.onload=function(ev) {
                Tesseract.recognize(ev.target.result,'ind',{logger:m=>console.log(m)})
                .then(({data:{text}})=>{
                    Swal.close();
                    const extracted=parseOCR(text);
                    fillForm(extracted);
                    Swal.fire({
                        icon:'success',
                        title:'OCR Berhasil!',
                        text:'Data berhasil diekstrak. Silakan cek dan lengkapi.',
                        confirmButtonText:'OK'
                    });
                })
                .catch(err=>{
                    Swal.close();
                    Swal.fire({
                        icon:'error',
                        title:'OCR Gagal',
                        text:'Terjadi kesalahan. Pastikan gambar jelas.'
                    });
                });
            };
            reader.readAsDataURL(file);
        }

        function parseOCR(text) {
            const data={};
            const namaM=text.match(/nama\s*[:\-]?\s*([^\n]+)/i);
            if(namaM)data.nama=namaM[1].trim();
            const nikM=text.match(/nik\s*[:\-]?\s*(\d+)/i);
            if(nikM)data.nik=nikM[1].trim();
            const umurM=text.match(/umur\s*[:\-]?\s*(\d+)/i);
            if(umurM)data.umur=umurM[1].trim();
            if(text.match(/laki[\-\s]*laki/i))data.jenisKelamin='Laki-laki';
            else if(text.match(/perempuan/i))data.jenisKelamin='Perempuan';
            return data;
        }

        function fillForm(data) {
            if(data.nama)document.getElementById('nama').value=data.nama;
            if(data.nik)document.getElementById('nik').value=data.nik;
            if(data.umur)document.getElementById('umur').value=data.umur;
            if(data.jenisKelamin)document.getElementById('jenisKelamin').value=data.jenisKelamin;
        }

        // CHAT
        function showChat() {
            document.getElementById('chatModal').classList.add('active');
        }

        function hideChat() {
            document.getElementById('chatModal').classList.remove('active');
        }

        function sendMessage() {
            const input=document.getElementById('chatInput');
            const msg=input.value.trim();
            if(!msg)return;
            
            const container=document.getElementById('chatContainer');
            
            container.innerHTML+=`
                <div class="chat-message user">
                    <div class="chat-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="chat-bubble">${msg}</div>
                </div>
            `;
            
            input.value='';
            container.scrollTop=container.scrollHeight;
            
            setTimeout(()=>{
                const response=getAIResponse(msg.toLowerCase());
                container.innerHTML+=`
                    <div class="chat-message bot">
                        <div class="chat-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="chat-bubble">${response}</div>
                    </div>
                `;
                container.scrollTop=container.scrollHeight;
            },500);
        }

        function getAIResponse(msg) {
            if(msg.includes('hb')||msg.includes('hemoglobin')) {
                return 'Hemoglobin normal:<br>\u2022 Perempuan: 12-16 g/dL<br>\u2022 Laki-laki: 13-18 g/dL';
            } else if(msg.includes('leukosit')) {
                return 'Nilai normal leukosit: 4000-10000 /\u00b5L';
            } else if(msg.includes('gula')||msg.includes('gds')) {
                return 'Gula Darah Sewaktu normal: 70-140 mg/dL';
            } else if(msg.includes('asamurat')||msg.includes('asam urat')) {
                return 'Asam urat normal:<br>\u2022 Perempuan: 2.4-6.0 mg/dL<br>\u2022 Laki-laki: 3.4-7.0 mg/dL';
            } else if(msg.includes('kolesterol')) {
                return 'Kolesterol total normal: <200 mg/dL';
            } else if(msg.includes('cara')||msg.includes('input')) {
                return 'Untuk input data pasien, klik menu "Input Lab" atau tombol + di pojok kanan bawah.';
            } else {
                return 'Maaf, saya belum paham. Coba tanyakan tentang nilai normal lab atau cara menggunakan aplikasi.';
            }
        }

        // DOWNLOAD EXCEL RECAP
        function downloadRecap() {
            if(db.length===0) {
                Swal.fire({
                    icon:'warning',
                    title:'Database Kosong',
                    text:'Tidak ada data untuk di-download'
                });
                return;
            }
            
            Swal.fire({
                title:'Download Recap Bulanan?',
                html:'<p>File akan berisi:</p><ul style="text-align:left;margin:10px 0 0 20px;"><li>Tabel lengkap data pasien</li><li>Hasil pemeriksaan lab lengkap</li><li>Statistik kategori pemeriksaan</li><li>Statistik gender pasien</li></ul>',
                icon:'question',
                showCancelButton:true,
                confirmButtonText:'Download',
                cancelButtonText:'Batal'
            }).then(r=>{
                if(r.isConfirmed) {
                    generateExcelRecap();
                }
            });
        }

        function generateExcelRecap() {
            const wb=XLSX.utils.book_new();
            
            // Sheet 1: Data Pasien Lengkap dengan Hasil Lab
            const patientData=db.map(p=>{
                const data={
                    'Tanggal':p.tanggal,
                    'Nama':p.nama,
                    'NIK/BPJS':p.nik||'-',
                    'Jenis Kelamin':p.jenisKelamin,
                    'Umur':p.umur||'-',
                    'Telepon':p.telepon||'-',
                    'Alamat':p.alamat||'-',
                    'Kategori':p.kategori,
                    'Catatan':p.catatan||'-',
                    'Petugas':p.petugas||'-'
                };
                
                // Tambahkan hasil pemeriksaan lab berdasarkan kategori
                if(p.parameters&&Object.keys(p.parameters).length>0) {
                    // Hematologi
                    if(p.kategori==='Hematologi') {
                        data['Hemoglobin (Hb) g/dL'] = p.parameters.hb || '-';
                        data['Leukosit /L'] = p.parameters.leukosit || '-';
                        data['Eritrosit juta/L'] = p.parameters.eritrosit || '-';
                        data['Trombosit /L'] = p.parameters.trombosit || '-';
                        data['Hematokrit %'] = p.parameters.hematokrit || '-';
                        data['LED mm/jam'] = p.parameters.led || '-';
                        data['MCH pg'] = p.parameters.mch || '-';
                        data['MCHC g/dL'] = p.parameters.mchc || '-';
                        data['MCV fL'] = p.parameters.mcv || '-';
                    }
                    // Kimia Darah
                    else if(p.kategori==='Kimia Darah') {
                        data['Gula Darah Sewaktu mg/dL'] = p.parameters.gds || '-';
                        data['Gula Darah Puasa mg/dL'] = p.parameters.gdp || '-';
                        data['Gula Darah 2 Jam PP mg/dL'] = p.parameters.gd2pp || '-';
                        data['Asam Urat mg/dL'] = p.parameters.asamurat || '-';
                        data['Kolesterol Total mg/dL'] = p.parameters.kolesterol || '-';
                        data['HDL mg/dL'] = p.parameters.hdl || '-';
                        data['LDL mg/dL'] = p.parameters.ldl || '-';
                        data['Trigliserida mg/dL'] = p.parameters.trigliserida || '-';
                        data['SGOT U/L'] = p.parameters.sgot || '-';
                        data['SGPT U/L'] = p.parameters.sgpt || '-';
                        data['Ureum mg/dL'] = p.parameters.ureum || '-';
                        data['Kreatinin mg/dL'] = p.parameters.kreatinin || '-';
                    }
                    // Urinalisis
                    else if(p.kategori==='Urinalisis') {
                        data['Warna'] = p.parameters.warna || '-';
                        data['Berat Jenis'] = p.parameters.berat_jenis || '-';
                        data['pH'] = p.parameters.ph || '-';
                        data['Protein'] = p.parameters.protein || '-';
                        data['Glukosa'] = p.parameters.glukosa || '-';
                        data['Keton'] = p.parameters.keton || '-';
                        data['Bilirubin'] = p.parameters.bilirubin || '-';
                        data['Urobilinogen'] = p.parameters.urobilinogen || '-';
                        data['Nitrit'] = p.parameters.nitrit || '-';
                        data['Eritrosit'] = p.parameters.eritrosit_urin || '-';
                        data['Leukosit'] = p.parameters.leukosit_urin || '-';
                        data['Silinder'] = p.parameters.silinder || '-';
                        data['Bakteri'] = p.parameters.bakteri || '-';
                        data['Fungi'] = p.parameters.fungi || '-';
                        data['Parasit'] = p.parameters.parasit || '-';
                    }
                    // Imunoserologi
                    else if(p.kategori==='Imunoserologi') {
                        data['Widal O'] = p.parameters.widal_o || '-';
                        data['Widal H'] = p.parameters.widal_h || '-';
                        data['HBsAg'] = p.parameters.hbsag || '-';
                        data['Anti-HCV'] = p.parameters.anti_hcv || '-';
                        data['HIV'] = p.parameters.hiv || '-';
                        data['RPR/VDRL'] = p.parameters.rpr || '-';
                        data['TPHA'] = p.parameters.tpa || '-';
                        data['Chikungunya IgM/IgG'] = p.parameters.chikungunya || '-';
                        data['Dengue IgM'] = p.parameters.dengue_igm || '-';
                        data['Dengue IgG'] = p.parameters.dengue_igg || '-';
                    }
                    // Mikrobiologi
                    else if(p.kategori==='Mikrobiologi') {
                        data['Hematologi'] = p.parameters.hematologi_kultur || '-';
                        data['Leukosit'] = p.parameters.leukosit_kultur || '-';
                        data['Trombosit'] = p.parameters.trombosit_kultur || '-';
                        data['Kultur'] = p.parameters.kultur || '-';
                        data['Biakan'] = p.parameters.biakan || '-';
                        data['Sensitivitas'] = p.parameters.sensitivitas || '-';
                        data['Pewarnaan Gram'] = p.parameters.gram || '-';
                        data['Fungi'] = p.parameters.fungi || '-';
                        data['Parasit'] = p.parameters.parasit || '-';
                        data['Pemeriksaan Mikroskopis'] = p.parameters.mikroskopis || '-';
                    }
                }
                
                return data;
            });
            
            const ws1=XLSX.utils.json_to_sheet(patientData);
            
            const wscols=[
                {wch:12},// Tanggal
                {wch:25},// Nama
                {wch:20},// NIK
                {wch:12},// JK
                {wch:8},// Umur
                {wch:15},// Telepon
                {wch:30},// Alamat
                {wch:15},// Kategori
                {wch:30},// Catatan
                {wch:20} // Petugas
            ];
            ws1['!cols']=wscols;
            
            XLSX.utils.book_append_sheet(wb,ws1,'Data Pasien & Hasil Lab');
            
            // Sheet 2: Statistik Kategori
            const categories={};
            db.forEach(p=>{
                const kat=p.kategori||'Lainnya';
                categories[kat]=(categories[kat]||0)+1;
            });
            
            const categoryData=Object.entries(categories).map(([name,count])=>({
                'Kategori Pemeriksaan':name,
                'Jumlah Pasien':count,
                'Persentase':((count/db.length)*100).toFixed(2)+'%'
            })).sort((a,b)=>b['Jumlah Pasien']-a['Jumlah Pasien']);
            
            const ws2=XLSX.utils.json_to_sheet(categoryData);
            ws2['!cols']=[{wch:20},{wch:15},{wch:12}];
            
            XLSX.utils.book_append_sheet(wb,ws2,'Statistik Kategori');
            
            // Sheet 3: Statistik Gender
            let l=0,p=0;
            db.forEach(d=>{
                if(d.jenisKelamin==='Laki-laki')l++;
                else if(d.jenisKelamin==='Perempuan')p++;
            });
            
            const genderData=[
                {'Jenis Kelamin':'Laki-laki','Jumlah Pasien':l,'Persentase':((l/db.length)*100).toFixed(2)+'%'},
                {'Jenis Kelamin':'Perempuan','Jumlah Pasien':p,'Persentase':((p/db.length)*100).toFixed(2)+'%'}
            ];
            
            const ws3=XLSX.utils.json_to_sheet(genderData);
            ws3['!cols']=[{wch:15},{wch:15},{wch:12}];
            
            XLSX.utils.book_append_sheet(wb,ws3,'Statistik Gender');
            
            // Sheet 4: Ringkasan Hasil per Kategori
            const summaryData=db.filter(p=>p.parameters&&Object.keys(p.parameters).length>0).map(p=>{
                const summary={
                    'Nama Pasien':p.nama,
                    'Kategori':p.kategori,
                    'Tanggal':p.tanggal
                };
                
                if(p.kategori==='Hematologi') {
                    summary['Hb (g/dL)'] = p.parameters.hb || '-';
                    summary['Leukosit (/L)'] = p.parameters.leukosit || '-';
                    summary['Trombosit (/L)'] = p.parameters.trombosit || '-';
                    summary['Hematokrit (%)'] = p.parameters.hematokrit || '-';
                } else if(p.kategori==='Kimia Darah') {
                    summary['GDS (mg/dL)'] = p.parameters.gds || '-';
                    summary['GDP (mg/dL)'] = p.parameters.gdp || '-';
                    summary['Asam Urat (mg/dL)'] = p.parameters.asamurat || '-';
                    summary['Kolesterol (mg/dL)'] = p.parameters.kolesterol || '-';
                } else if(p.kategori==='Urinalisis') {
                    summary['Warna'] = p.parameters.warna || '-';
                    summary['pH'] = p.parameters.ph || '-';
                    summary['Protein'] = p.parameters.protein || '-';
                    summary['Glukosa'] = p.parameters.glukosa || '-';
                } else if(p.kategori==='Imunoserologi') {
                    summary['Widal O'] = p.parameters.widal_o || '-';
                    summary['HBsAg'] = p.parameters.hbsag || '-';
                    summary['HIV'] = p.parameters.hiv || '-';
                } else if(p.kategori==='Mikrobiologi') {
                    summary['Kultur'] = p.parameters.kultur || '-';
                    summary['Biakan'] = p.parameters.biakan || '-';
                    summary['Sensitivitas'] = p.parameters.sensitivitas || '-';
                }
                
                return summary;
            });
            
            const ws4=XLSX.utils.json_to_sheet(summaryData);
            ws4['!cols']=[{wch:25},{wch:15},{wch:12},{wch:15},{wch:15},{wch:15},{wch:15},{wch:15}];
            
            XLSX.utils.book_append_sheet(wb,ws4,'Ringkasan Hasil Lab');
            
            const month=new Date().toLocaleDateString('id-ID',{month:'long',year:'numeric'});
            XLSX.writeFile(wb,`SisterLab_Recap_${month}.xlsx`);
            
            Swal.fire({
                icon:'success',
                title:'Download Berhasil!',
                html:`<p>File Excel recap bulanan telah diunduh</p><p style="font-size:0.875rem;color:#64748b;margin-top:8px;">Berisi: Data Pasien, Hasil Lab Lengkap, Statistik Kategori & Gender, Ringkasan Hasil</p>`,
                timer:3000,
                showConfirmButton:false
            });
        }

        // BACKUP
        function downloadBackup() {
            if(db.length===0) {
                Swal.fire({
                    icon:'warning',
                    title:'Database Kosong',
                    text:'Tidak ada data untuk di-backup'
                });
                return;
            }
            
            const backup={
                version:'2.0',
                timestamp:new Date().toISOString(),
                user:currentUser.username,
                theme:currentTheme,
                darkMode:document.documentElement.getAttribute('data-theme')==='dark',
                data:db,
                logo:appLogo
            };
            
            const json=JSON.stringify(backup,null,2);
            const blob=new Blob([json],{type:'application/json'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;
            a.download=`SisterLab_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            Swal.fire({
                icon:'success',
                title:'Backup Berhasil!',
                text:'File backup telah diunduh'
            });
        }

        function restoreBackup(e) {
            const file=e.target.files[0];
            if(!file)return;
            
            const reader=new FileReader();
            reader.onload=function(ev) {
                try {
                    const backup=JSON.parse(ev.target.result);
                    if(!backup.data||!Array.isArray(backup.data)) {
                        throw new Error('Format tidak valid');
                    }
                    
                    Swal.fire({
                        title:'Restore Database?',
                        html:`<p>File berisi <strong>${backup.data.length}</strong> record</p><p style="color:#ef4444;">\u26a0\ufe0f Data saat ini akan diganti!</p>`,
                        icon:'warning',
                        showCancelButton:true,
                        confirmButtonText:'Ya, Restore',
                        cancelButtonText:'Batal'
                    }).then(r=>{
                        if(r.isConfirmed) {
                            db=backup.data;
                            if(backup.logo) {
                                appLogo=backup.logo;
                                localStorage.setItem('sisterlab_logo',appLogo);
                                applyLogo();
                            }
                            if(backup.theme) {
                                currentTheme=backup.theme;
                                localStorage.setItem('sisterlab_theme',currentTheme);
                                applyTheme();
                            }
                            if(backup.darkMode) {
                                document.documentElement.setAttribute('data-theme','dark');
                                localStorage.setItem('sisterlab_dark','true');
                                updateDarkModeUI(true);
                            } else {
                                document.documentElement.removeAttribute('data-theme');
                                localStorage.setItem('sisterlab_dark','false');
                                updateDarkModeUI(false);
                            }
                            saveDB();
                            Swal.fire({
                                icon:'success',
                                title:'Restore Berhasil!',
                                text:`${backup.data.length} data dipulihkan`
                            });
                        }
                    });
                } catch(err) {
                    Swal.fire({
                        icon:'error',
                        title:'Restore Gagal',
                        text:'File backup tidak valid'
                    });
                }
            };
            reader.readAsText(file);
            e.target.value='';
        }

        function resetDatabase() {
            Swal.fire({
                title:'Reset Database?',
                html:'<p style="color:#ef4444;font-weight:bold;">\u26a0\ufe0f PERINGATAN!</p><p>Semua data akan dihapus permanen!</p>',
                icon:'warning',
                input:'text',
                inputPlaceholder:'Ketik "RESET" untuk konfirmasi',
                showCancelButton:true,
                confirmButtonText:'Ya, Reset',
                cancelButtonText:'Batal',
                confirmButtonColor:'#ef4444',
                inputValidator:v=>{
                    if(v!=='RESET')return 'Ketik "RESET" untuk melanjutkan';
                }
            }).then(r=>{
                if(r.isConfirmed) {
                    db=[];
                    saveDB();
                    Swal.fire({
                        icon:'success',
                        title:'Database Direset!',
                        timer:1500,
                        showConfirmButton:false
                    });
                }
            });
        }

        // PRINT
        function printPatient(id) {
            const p=db.find(x=>x.id===id);
            if(!p)return;
            
            const printArea=document.getElementById('printArea');
            const logoHtml=appLogo?`<img src="${appLogo}" style="width:80px;height:80px;object-fit:cover;border-radius:12px;">`:'<div style="width:80px;height:80px;background:#06b6d4;border-radius:12px;"></div>';
            
            let paramsHtml='';
            if(p.parameters&&Object.keys(p.parameters).length>0) {
                paramsHtml='<div style="margin-bottom:24px;"><strong>Hasil Pemeriksaan:</strong><table style="width:100%;margin-top:8px;border-collapse:collapse;"><thead><tr style="background:#f1f5f9;"><th style="padding:8px;text-align:left;border:1px solid #ddd;">Parameter</th><th style="padding:8px;text-align:left;border:1px solid #ddd;">Hasil</th></tr></thead><tbody>';
                Object.entries(p.parameters).forEach(([key,value])=>{
                    paramsHtml+=`<tr><td style="padding:8px;border:1px solid #ddd;">${formatParamName(key)}</td><td style="padding:8px;border:1px solid #ddd;">${value}</td></tr>`;
                });
                paramsHtml+='</tbody></table></div>';
            }
            
            printArea.innerHTML=`
                <div style="padding:20mm;font-family:'Inter',Arial,sans-serif;">
                    <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:3px double #000;padding-bottom:16px;margin-bottom:24px;">
                        ${logoHtml}
                        <div style="flex:1;text-align:center;">
                            <h1 style="font-size:1.5rem;margin-bottom:4px;">PUSKESMAS MEUREUBO</h1>
                            <p style="font-size:0.875rem;">Jl. Raya Meureubo, Kec. Meureubo, Kab. Aceh Barat</p>
                        </div>
                        <div style="width:80px;"></div>
                    </div>
                    <h2 style="text-align:center;margin:24px 0;">HASIL PEMERIKSAAN LABORATORIUM</h2>
                    <table style="width:100%;margin-bottom:24px;">
                        <tr><td style="width:150px;padding:6px;">Nama Pasien</td><td>: ${p.nama}</td></tr>
                        <tr><td style="padding:6px;">NIK/BPJS</td><td>: ${p.nik||'-'}</td></tr>
                        <tr><td style="padding:6px;">Jenis Kelamin</td><td>: ${p.jenisKelamin}</td></tr>
                        <tr><td style="padding:6px;">Umur</td><td>: ${p.umur||'-'} tahun</td></tr>
                        <tr><td style="padding:6px;">Tanggal</td><td>: ${formatDate(p.tanggal)}</td></tr>
                        <tr><td style="padding:6px;">Kategori</td><td>: ${p.kategori}</td></tr>
                    </table>
                    ${paramsHtml}
                    ${p.catatan?`<div style="margin-bottom:24px;"><strong>Catatan:</strong><br>${p.catatan}</div>`:''}
                    <div style="margin-top:48px;text-align:right;">
                        <p>Meureubo, ${new Date().toLocaleDateString('id-ID',{day:'numeric',month:'long',year:'numeric'})}</p>
                        <p>Petugas Lab,</p>
                        <p style="margin-top:64px;"><u>${p.petugas||currentUser.fullName}</u></p>
                    </div>
                </div>
            `;
            
            printArea.style.display='block';
            window.print();
            setTimeout(()=>{printArea.style.display='none';},100);
        }

        // UTILS
        function formatDate(d) {
            if(!d)return'-';
            const date=new Date(d);
            return date.toLocaleDateString('id-ID',{day:'numeric',month:'short',year:'numeric'});
        }

        function formatParamName(id) {
            const nameMap={
                hb:'Hemoglobin (Hb)',
                leukosit:'Leukosit',
                eritrosit:'Eritrosit',
                trombosit:'Trombosit',
                hematokrit:'Hematokrit',
                led:'LED',
                mch:'MCH',
                mchc:'MCHC',
                mcv:'MCV',
                gds:'Gula Darah Sewaktu',
                gdp:'Gula Darah Puasa',
                gd2pp:'Gula Darah 2 Jam PP',
                asamurat:'Asam Urat',
                kolesterol:'Kolesterol Total',
                hdl:'HDL',
                ldl:'LDL',
                trigliserida:'Trigliserida',
                sgot:'SGOT',
                sgpt:'SGPT',
                ureum:'Ureum',
                kreatinin:'Kreatinin',
                warna:'Warna',
                berat_jenis:'Berat Jenis',
                ph:'pH',
                protein:'Protein',
                glukosa:'Glukosa',
                keton:'Keton',
                bilirubin:'Bilirubin',
                urobilinogen:'Urobilinogen',
                nitrit:'Nitrit',
                eritrosit_urin:'Eritrosit',
                leukosit_urin:'Leukosit',
                silinder:'Silinder',
                bakteri:'Bakteri',
                fungi:'Fungi',
                parasit:'Parasit',
                mikroskopis:'Pemeriksaan Mikroskopis',
                widal_o:'Widal O',
                widal_h:'Widal H',
                hbsag:'HBsAg',
                anti_hcv:'Anti-HCV',
                hiv:'HIV',
                rpr:'RPR/VDRL',
                tpa:'TPHA',
                chikungunya:'Chikungunya IgM/IgG',
                dengue_igm:'Dengue IgM',
                dengue_igg:'Dengue IgG'
            };
            return nameMap[id]||id;
        }

        console.log(' SisterLab v2.0 - FIXED LOGIN BUG');
    </script>
</body>
    </html>
